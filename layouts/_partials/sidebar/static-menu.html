{{$currentNode := .}}
<nav class="static-menu">
<ul>
  <li class="{{ if .IsHome }}active{{ end }}"><a href="{{ .Site.BaseURL }}">Home</a></li>

  {{- $order := or .Site.Params.sidebar.ordersectionsby .Site.Params.ordersectionsby -}}
  {{- if eq $order "title" -}}
    {{- range .Site.Home.Sections.ByTitle -}}
      {{ template "static-menu" dict "sect" . "currentnode" $currentNode }}
    {{- end -}}
  {{- else -}}
    {{- range .Site.Home.Sections.ByWeight -}}
      {{ template "static-menu" dict "sect" . "currentnode" $currentNode }}
    {{- end -}}
  {{- end}}
</ul>
</nav>

{{ define "static-menu" }}
  {{- $currentNode := .currentnode -}}
  {{ with .sect }}
    {{- $sidebar := .Site.Params.sidebar -}}
    {{- $order := or $sidebar.ordersectionsby .Site.Params.ordersectionsby -}}
    {{- $collapseAll := and $sidebar (in $sidebar.collapse_sections .Section) -}}
    {{- $hidePages  := and $sidebar (in $sidebar.hide_pages_in_sections .Section) -}}

    {{ if .IsSection }}
      {{ if in .Site.Params.menu_exclusion .Section }}
        {{/* skip excluded sections entirely */}}
      {{ else }}
        {{- safeHTML .Params.head -}}

        {{/* Count children respecting flags */}}
        {{- $childCount := cond $collapseAll 0 (cond $hidePages (len .Sections) (add (len .Pages) (len .Sections))) -}}

        <li class="{{ if .IsAncestor $currentNode }}parent{{ end }}{{ if and .File $currentNode.File }}{{ if eq .File.UniqueID $currentNode.File.UniqueID }} active{{ end }}{{ end }}{{ if .Params.alwaysopen }} parent{{ end }}">
          <a href="{{ .Permalink }}">{{ safeHTML .Params.Pre }}{{ .Title }}{{ safeHTML .Params.Post }}</a>

          {{ if and (ne $childCount 0) (not $collapseAll) }}
            <ul class="sub-menu">
              {{- if $hidePages -}}
                {{- $children := .Sections -}}
                {{- if eq $order "title" -}}
                  {{- range $children.ByTitle -}}
                    {{- if and .Params.hidden (not $.showhidden) -}}{{ else -}}
                      {{ template "static-menu" dict "sect" . "currentnode" $currentNode }}
                    {{- end -}}
                  {{- end -}}
                {{- else -}}
                  {{- range $children.ByWeight -}}
                    {{- if and .Params.hidden (not $.showhidden) -}}{{ else -}}
                      {{ template "static-menu" dict "sect" . "currentnode" $currentNode }}
                    {{- end -}}
                  {{- end -}}
                {{- end -}}
              {{- else -}}
                {{- .Scratch.Set "pages" .Pages -}}
                {{- if .Sections -}}
                  {{- .Scratch.Set "pages" (.Pages | union .Sections) -}}
                {{- end -}}
                {{- $children := (.Scratch.Get "pages") -}}
                {{- if eq $order "title" -}}
                  {{- range $children.ByTitle -}}
                    {{- if and .Params.hidden (not $.showhidden) -}}{{ else -}}
                      {{ template "static-menu" dict "sect" . "currentnode" $currentNode }}
                    {{- end -}}
                  {{- end -}}
                {{- else -}}
                  {{- range $children.ByWeight -}}
                    {{- if and .Params.hidden (not $.showhidden) -}}{{ else -}}
                      {{ template "static-menu" dict "sect" . "currentnode" $currentNode }}
                    {{- end -}}
                  {{- end -}}
                {{- end -}}
              {{- end -}}
            </ul>
          {{ end }}
        </li>
      {{- end -}}
    {{- else -}}
      {{- if not .Params.Hidden -}}
        <li class="{{ if and .File $currentNode.File }}{{ if eq .File.UniqueID $currentNode.File.UniqueID }}active{{ end }}{{ end }}">
          <a href="{{ .Permalink }}">{{ safeHTML .Params.Pre }}{{ .Title }}{{ safeHTML .Params.Post }}</a>
        </li>
      {{- end -}}
    {{- end -}}
  {{- end -}}
{{ end }}
